id: cors-misconfig-pro-fixed

info:
  name: CORS Misconfiguration (Wildcard / Origin Reflection / Credentials)
  author: guigavicentin
  severity: medium
  description: Detects wildcard ACAO, origin reflection and credentials enabled with insecure origin.
  tags: cors,misconfig,headers,custom

http:
  - raw:
      - |
        GET / HTTP/1.1
        Host: {{Hostname}}
        Origin: {{cors_origin}}
        User-Agent: nuclei

    payloads:
      cors_origin:
        - "https://{{randstr}}.evil.com"
        - "http://{{randstr}}.evil.com"
        - "null"

    stop-at-first-match: true

    matchers-condition: or
    matchers:
      # 1) Wildcard ACAO
      - type: dsl
        name: wildcard-acao
        dsl:
          - "contains(tolower(header), 'access-control-allow-origin: *')"

      # 2) Origin refletida (qualquer origin que enviamos volta no ACAO)
      - type: dsl
        name: reflected-origin
        dsl:
          - "contains(tolower(header), 'access-control-allow-origin: {{cors_origin}}')"

      # 3) Credenciais habilitadas + origin refletida (mais grave)
      - type: dsl
        name: creds-with-reflection
        dsl:
          - "contains(tolower(header), 'access-control-allow-origin: {{cors_origin}}') && contains(tolower(header), 'access-control-allow-credentials: true')"

    extractors:
      - type: regex
        part: header
        name: acao
        regex:
          - "(?im)^Access-Control-Allow-Origin\\s*:\\s*(.*)$"
      - type: regex
        part: header
        name: acac
        regex:
          - "(?im)^Access-Control-Allow-Credentials\\s*:\\s*(.*)$"
